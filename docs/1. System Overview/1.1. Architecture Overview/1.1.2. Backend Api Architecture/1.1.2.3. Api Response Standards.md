# API Response Standards



## Table of Contents
1. [Introduction](#introduction)
2. [Response Structure](#response-structure)
3. [Success Response Patterns](#success-response-patterns)
4. [Error Response Patterns](#error-response-patterns)
5. [Utility Functions](#utility-functions)
6. [HTTP Status Code Mapping](#http-status-code-mapping)
7. [Common Response Examples](#common-response-examples)
8. [Frontend Handling Guidance](#frontend-handling-guidance)
9. [Content Negotiation](#content-negotiation)
10. [Error Code Taxonomy](#error-code-taxonomy)
11. [Versioning Considerations](#versioning-considerations)

## Introduction
The exim-pilot API implements a standardized response format across all endpoints to ensure consistency, predictability, and ease of integration. This document details the response structure, utility functions, error handling patterns, and best practices for both backend implementation and frontend consumption. The standardized format enables clients to reliably parse responses, handle errors, and extract data regardless of the specific endpoint being called.

**Section sources**
- [response.go](file://internal/api/response.go#L0-L90)
- [server.go](file://internal/api/server.go#L256-L273)

## Response Structure
The API uses a consistent JSON structure for all responses, defined by the `APIResponse` struct in `response.go`. This structure includes four primary fields that provide comprehensive information about the response status, data, errors, and metadata.


```mermaid
classDiagram
class APIResponse {
+bool Success
+interface{} Data
+string Error
+Meta Meta
}
class Meta {
+int Page
+int PerPage
+int Total
+int TotalPages
}
APIResponse --> Meta : "has optional"
```


**Diagram sources**
- [response.go](file://internal/api/response.go#L0-L25)

### Response Fields
**Success**: A boolean field indicating whether the request was successful. This is the primary indicator for clients to determine response outcome.

**Data**: An interface{} field containing the response payload when the request is successful. This can be any JSON-serializable data structure, including objects, arrays, strings, or numbers.

**Error**: A string field containing the error message when the request fails. This field is omitted in successful responses.

**Meta**: An optional `Meta` object containing pagination and additional metadata for list operations. This field is omitted when not applicable.

The `Meta` structure supports pagination information with the following fields:
- **Page**: Current page number (1-based)
- **PerPage**: Number of items per page
- **Total**: Total number of items across all pages
- **TotalPages**: Total number of pages available

**Section sources**
- [response.go](file://internal/api/response.go#L0-L25)
- [api.ts](file://web/src/types/api.ts#L0-L18)

## Success Response Patterns
Successful responses follow a consistent pattern using utility functions that create properly formatted `APIResponse` objects with appropriate HTTP status codes.

### Basic Success Response
The simplest success response contains only the success flag and data payload:


```go
func WriteSuccessResponse(w http.ResponseWriter, data interface{}) {
    response := APIResponse{
        Success: true,
        Data:    data,
    }
    WriteJSONResponse(w, http.StatusOK, response)
}
```


This function is used for most successful operations and returns HTTP status 200 (OK).

### Success Response with Metadata
For paginated responses, the API includes metadata about the pagination state:


```go
func WriteSuccessResponseWithMeta(w http.ResponseWriter, data interface{}, meta *Meta) {
    response := APIResponse{
        Success: true,
        Data:    data,
        Meta:    meta,
    }
    WriteJSONResponse(w, http.StatusOK, response)
}
```


This pattern is commonly used in list endpoints like queue listings and log searches.

### Health Check Response
The health check endpoint demonstrates a specific success response pattern:


```go
func (s *Server) handleHealth(w http.ResponseWriter, r *http.Request) {
    response := APIResponse{
        Success: true,
        Data: map[string]interface{}{
            "status":    "healthy",
            "timestamp": time.Now().UTC(),
            "version":   "1.0.0",
        },
    }
    WriteJSONResponse(w, http.StatusOK, response)
}
```


This response includes system status, current timestamp, and version information in the data payload.

**Section sources**
- [response.go](file://internal/api/response.go#L0-L43)
- [server.go](file://internal/api/server.go#L256-L273)
- [queue_handlers.go](file://internal/api/queue_handlers.go#L48-L93)

## Error Response Patterns
The API implements a comprehensive error handling system with specialized functions for different error types, ensuring consistent error responses across all endpoints.

### Generic Error Response
The base error response function allows for custom status codes and messages:


```go
func WriteErrorResponse(w http.ResponseWriter, statusCode int, message string) {
    response := APIResponse{
        Success: false,
        Error:   message,
    }
    WriteJSONResponse(w, statusCode, response)
}
```


### Specific Error Response Functions
The API provides convenience functions for common HTTP error types:


```go
func WriteBadRequestResponse(w http.ResponseWriter, message string) {
    WriteErrorResponse(w, http.StatusBadRequest, message)
}

func WriteNotFoundResponse(w http.ResponseWriter, message string) {
    WriteErrorResponse(w, http.StatusNotFound, message)
}

func WriteInternalErrorResponse(w http.ResponseWriter, message string) {
    WriteErrorResponse(w, http.StatusInternalServerError, message)
}

func WriteUnauthorizedResponse(w http.ResponseWriter, message string) {
    WriteErrorResponse(w, http.StatusUnauthorized, message)
}

func WriteForbiddenResponse(w http.ResponseWriter, message string) {
    WriteErrorResponse(w, http.StatusForbidden, message)
}

func WriteMethodNotAllowedResponse(w http.ResponseWriter, message string) {
    WriteErrorResponse(w, http.StatusMethodNotAllowed, message)
}
```


These functions ensure consistent error messaging and appropriate HTTP status codes for different error scenarios.

**Section sources**
- [response.go](file://internal/api/response.go#L40-L90)
- [middleware.go](file://internal/api/middleware.go#L50-L104)
- [auth_handlers.go](file://internal/api/auth_handlers.go#L48-L100)

## Utility Functions
The API provides several utility functions to simplify response creation and ensure consistency across handlers.

### WriteJSONResponse
This core function handles the actual HTTP response writing with proper headers and error handling:


```go
func WriteJSONResponse(w http.ResponseWriter, statusCode int, response APIResponse) {
    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(statusCode)

    if err := json.NewEncoder(w).Encode(response); err != nil {
        // If we can't encode the response, write a basic error
        http.Error(w, `{"success":false,"error":"Failed to encode response"}`, http.StatusInternalServerError)
    }
}
```


This function sets the appropriate Content-Type header, writes the status code, and encodes the response as JSON. It includes a fallback error response in case JSON encoding fails.

### Validation Error Response
The validation middleware demonstrates a specialized error response pattern that includes validation details:


```go
if validationErrors, ok := err.(*validation.ValidationErrors); ok {
    response := APIResponse{
        Success: false,
        Error:   "Validation failed",
        Data:    validationErrors.Errors,
    }
    WriteJSONResponse(w, http.StatusBadRequest, response)
    return
}
```


This pattern includes detailed validation error information in the Data field while maintaining the standard response structure.

**Section sources**
- [response.go](file://internal/api/response.go#L0-L43)
- [middleware.go](file://internal/api/middleware.go#L141-L183)

## HTTP Status Code Mapping
The API follows standard HTTP status code semantics with a clear mapping between application-level conditions and HTTP status codes.

### Success Codes
**200 OK**: Standard success response for GET, PUT, POST, and DELETE operations
**201 Created**: Used for successful resource creation (not currently implemented)
**204 No Content**: Used for successful operations with no response body (not currently implemented)

### Client Error Codes
**400 Bad Request**: Invalid request parameters, malformed JSON, or validation failures
**401 Unauthorized**: Authentication required or invalid/expired session
**403 Forbidden**: Authenticated user lacks permission for the requested operation
**404 Not Found**: Requested resource does not exist
**405 Method Not Allowed**: HTTP method not supported for the requested endpoint
**422 Unprocessable Entity**: Semantic errors in request (not currently used)

### Server Error Codes
**500 Internal Server Error**: Unexpected server error or unhandled exception
**503 Service Unavailable**: Service temporarily unavailable (not currently used)

The mapping ensures that clients can interpret response status codes according to standard HTTP semantics while the response body provides additional application-specific details.

**Section sources**
- [response.go](file://internal/api/response.go#L40-L90)
- [middleware.go](file://internal/api/middleware.go#L50-L104)
- [auth_handlers.go](file://internal/api/auth_handlers.go#L48-L100)

## Common Response Examples
This section provides concrete examples of API responses for common operations across different functional areas.

### Queue Actions
**Queue List Response (Success)**:

```json
{
  "success": true,
  "data": {
    "messages": [
      {
        "id": "12345",
        "sender": "user@example.com",
        "recipients": ["recipient@example.com"],
        "subject": "Test Message",
        "size": 1024,
        "age": "2h",
        "status": "deferred"
      }
    ],
    "total_messages": 150,
    "deferred_messages": 25,
    "frozen_messages": 5,
    "oldest_message_age": "48h"
  },
  "meta": {
    "page": 1,
    "per_page": 50,
    "total": 150,
    "total_pages": 3
  }
}
```


**Queue Delete Response (Success)**:

```json
{
  "success": true,
  "data": {
    "message_id": "12345",
    "operation": "delete",
    "success": true,
    "timestamp": "2023-12-07T10:30:00Z"
  }
}
```


**Queue Action Response (Error)**:

```json
{
  "success": false,
  "error": "Message ID is required"
}
```


### Log Searches
**Log Search Response (Success)**:

```json
{
  "success": true,
  "data": {
    "entries": [
      {
        "id": "log_001",
        "timestamp": "2023-12-07T10:30:00Z",
        "event_type": "delivery",
        "message_id": "12345",
        "recipient": "user@example.com",
        "status": "sent",
        "details": "Delivered to MX server"
      }
    ],
    "search_time": "125ms",
    "aggregations": {
      "by_event_type": {
        "delivery": 45,
        "bounce": 5,
        "defer": 10
      }
    },
    "criteria": {
      "start_time": "2023-12-07T00:00:00Z",
      "end_time": "2023-12-07T23:59:59Z",
      "event_type": "delivery"
    }
  },
  "meta": {
    "page": 1,
    "per_page": 100,
    "total": 60,
    "total_pages": 1
  }
}
```


**Log Search Response (Error)**:

```json
{
  "success": false,
  "error": "Failed to perform advanced search"
}
```


### Authentication
**Login Response (Success)**:

```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "full_name": "Administrator"
    },
    "expires_at": "2023-12-08T10:30:00Z"
  }
}
```


**Login Response (Error)**:

```json
{
  "success": false,
  "error": "Invalid credentials"
}
```


**Logout Response (Success)**:

```json
{
  "success": true,
  "data": {
    "message": "Logged out successfully"
  }
}
```


**Logout Response (Error)**:

```json
{
  "success": false,
  "error": "No active session"
}
```


**Section sources**
- [queue_handlers.go](file://internal/api/queue_handlers.go#L48-L93)
- [log_handlers.go](file://internal/api/log_handlers.go#L129-L167)
- [auth_handlers.go](file://internal/api/auth_handlers.go#L48-L100)
- [reports_handlers.go](file://internal/api/reports_handlers.go#L72-L116)

## Frontend Handling Guidance
Frontend applications should implement consistent patterns for handling API responses to ensure reliable user experiences.

### Response Parsing
All API responses should be parsed using the same pattern:


```typescript
interface APIResponse<T = any> {
  success: boolean;
  data?: T;
  error?: string;
  meta?: {
    page?: number;
    per_page?: number;
    total?: number;
    total_pages?: number;
  };
}
```


Clients should first check the `success` field to determine response outcome before accessing `data` or `error` fields.

### Error Handling
The frontend implements a comprehensive error handling system in `errorHandler.ts`:


```typescript
export function handleAPIError(error: any): AppError {
  if (error instanceof AppError) {
    return error;
  }

  if (error.response) {
    // HTTP error response
    const { status, data } = error.response;
    const message = data?.error || data?.message || `HTTP Error ${status}`;
    const code = data?.code || `HTTP_${status}`;
    return new AppError(message, code, status);
  }

  if (error.request) {
    // Network error
    return new AppError(
      'Network error. Please check your connection.',
      'NETWORK_ERROR'
    );
  }

  if (error instanceof Error) {
    return new AppError(error.message, 'GENERIC_ERROR');
  }

  return new AppError('An unknown error occurred', 'UNKNOWN_ERROR');
}
```


This handler normalizes different error types (HTTP responses, network errors, JavaScript errors) into a consistent `AppError` format.

### Helper Functions
Additional utility functions simplify error handling:


```typescript
export function getErrorMessage(error: any): string {
  if (error instanceof AppError) {
    return error.message;
  }

  if (error?.message) {
    return error.message;
  }

  if (typeof error === 'string') {
    return error;
  }

  return 'An unexpected error occurred';
}

export function isNetworkError(error: any): boolean {
  return error?.code === 'NETWORK_ERROR' || 
         error?.message?.includes('Network Error') ||
         error?.message?.includes('fetch');
}

export function isAuthError(error: any): boolean {
  return error?.statusCode === 401 || 
         error?.statusCode === 403 ||
         error?.code === 'UNAUTHORIZED' ||
         error?.code === 'FORBIDDEN';
}
```


These functions enable frontend components to easily identify error types and display appropriate messages to users.

**Section sources**
- [errorHandler.ts](file://web/src/utils/errorHandler.ts#L0-L83)
- [api.ts](file://web/src/services/api.ts#L86-L118)

## Content Negotiation
The API currently supports only JSON responses with the following content negotiation characteristics:

- **Content-Type**: All API responses use `application/json` as the content type
- **Accept Header**: The API does not currently validate or negotiate based on the Accept header
- **Response Format**: JSON is the only supported response format
- **Character Encoding**: UTF-8 encoding is used for all responses

The `contentTypeMiddleware` ensures proper content type headers:


```go
func (s *Server) contentTypeMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // Only set default content-type for API responses, not static files
        if strings.HasPrefix(r.URL.Path, "/api/") && w.Header().Get("Content-Type") == "" {
            w.Header().Set("Content-Type", "application/json")
        }

        // Call the next handler
        next.ServeHTTP(w, r)
    })
}
```


This middleware automatically sets the content type for API responses, ensuring consistency across all endpoints.

**Section sources**
- [middleware.go](file://internal/api/middleware.go#L141-L148)

## Error Code Taxonomy
The API implements a consistent error handling taxonomy that categorizes errors by type and source.

### Backend Error Categories
**Validation Errors**: Invalid input parameters, missing required fields, or data format issues
**Authentication Errors**: Invalid credentials, expired sessions, or missing authentication
**Authorization Errors**: Insufficient permissions for requested operations
**Resource Errors**: Requested resources not found or conflicts with existing resources
**System Errors**: Database connectivity issues, internal server errors, or service failures

### Frontend Error Classification
The frontend extends the backend error taxonomy with additional categories:


```typescript
export class AppError extends Error {
  public code: string;
  public statusCode?: number;

  constructor(message: string, code: string = 'UNKNOWN_ERROR', statusCode?: number) {
    super(message);
    this.name = 'AppError';
    this.code = code;
    this.statusCode = statusCode;
  }
}
```


**Error Codes**:
- **UNKNOWN_ERROR**: Generic unknown error
- **NETWORK_ERROR**: Network connectivity issues
- **GENERIC_ERROR**: General JavaScript errors
- **HTTP_XXX**: HTTP status code errors (e.g., HTTP_404, HTTP_500)
- **UNAUTHORIZED**: Authentication-specific errors
- **FORBIDDEN**: Authorization-specific errors

This taxonomy enables both frontend and backend to handle errors consistently and provide meaningful feedback to users.

**Section sources**
- [response.go](file://internal/api/response.go#L40-L90)
- [errorHandler.ts](file://web/src/utils/errorHandler.ts#L0-L55)

## Versioning Considerations
The API response standards are designed with future versioning in mind to ensure backward compatibility and smooth transitions.

### Backward Compatibility
The response structure prioritizes backward compatibility:
- New fields are added as optional to avoid breaking existing clients
- Required fields remain stable across versions
- Field names and types are not changed in minor versions
- Deprecation notices are included in API documentation before removal

### Versioning Strategy
The current implementation uses URL-based versioning with the `/api/v1/` prefix:
- **URL Versioning**: `/api/v1/` indicates the API version
- **Semantic Versioning**: Major versions indicate breaking changes
- **Long-term Support**: Previous versions are supported during transition periods

### Future Enhancements
Potential future improvements include:
- **Response Envelope Expansion**: Adding version information to the response envelope
- **Field Deprecation**: Using the Meta field to indicate deprecated fields
- **Conditional Responses**: Supporting client-requested response formats
- **Error Code Standardization**: Implementing a comprehensive error code registry

The current design allows for these enhancements without breaking existing integrations.

**Section sources**
- [server.go](file://internal/api/server.go#L90-L117)
- [response.go](file://internal/api/response.go#L0-L90)
- [README.md](file://internal/api/README.md#L80-L118)

**Referenced Files in This Document**   
- [response.go](file://internal/api/response.go)
- [server.go](file://internal/api/server.go)
- [auth_handlers.go](file://internal/api/auth_handlers.go)
- [queue_handlers.go](file://internal/api/queue_handlers.go)
- [log_handlers.go](file://internal/api/log_handlers.go)
- [reports_handlers.go](file://internal/api/reports_handlers.go)
- [message_trace_handlers.go](file://internal/api/message_trace_handlers.go)
- [middleware.go](file://internal/api/middleware.go)
- [api.ts](file://web/src/types/api.ts)
- [errorHandler.ts](file://web/src/utils/errorHandler.ts)